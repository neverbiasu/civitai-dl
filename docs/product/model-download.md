# 模型下载

## 功能概述

模型下载模块基于Civitai下载API实现，负责高效、可靠地获取模型文件。所有功能设计严格遵循API能力范围，并处理各种下载场景。

### 核心价值

- 高效获取：利用API提供的直接下载链接
- 智能管理：基于API返回的模型元数据进行组织
- 稳定可靠：实现断点续传和错误恢复
- 批量处理：基于搜索API结果实现批量下载

## API依赖流程

### 单模型下载流程

1. 获取模型信息: `GET /api/v1/models/:modelId`
2. 获取版本信息: `GET /api/v1/model-versions/:versionId`（可选）
3. 执行下载: `GET /api/download/models/:modelVersionId`
4. 处理文件名: 从`content-disposition`头获取
5. 验证文件: 使用API提供的哈希值

### 批量下载流程

1. 获取模型列表: 通过各种筛选条件调用`GET /api/v1/models`
2. 提取版本ID: 从返回的`modelVersions`数组获取
3. 创建下载队列: 为每个版本创建下载任务
4. 执行并行下载: 控制并发数避免API限制

## 基本功能

### 模型获取（基于下载API）

| 功能       | API实现                           | API限制和注意事项                |
| ---------- | --------------------------------- | -------------------------------- |
| 单模型下载 | `/api/download/models/:versionId` | 部分模型需要API密钥认证          |
| 批量下载   | 多次调用下载API                   | 需控制并发数避免服务器限制       |
| 版本选择   | 基于`modelVersions`数组数据       | 需先获取模型详情才能获知所有版本 |

### 下载控制（本地功能 + API特性）

| 功能      | 实现方式                     | API依赖程度                       |
| --------- | ---------------------------- | --------------------------------- |
| 暂停/恢复 | 本地下载状态管理 + Range请求 | 依赖API服务器支持Range头          |
| 取消任务  | 本地任务管理                 | 纯本地功能，终止对应HTTP请求      |
| 自动重试  | 本地错误处理与重试逻辑       | 纯本地功能，按策略重新发起API请求 |
| 断点续传  | HTTP Range请求               | 依赖API服务器正确处理Range请求    |

## 高级功能

### 下载管理（本地实现，基于API数据）

| 功能       | 实现方式                    | API数据依赖                        |
| ---------- | --------------------------- | ---------------------------------- |
| 优先级队列 | 本地队列管理                | 不依赖API，纯本地功能              |
| 格式优选   | 解析API返回的文件格式元数据 | 依赖`modelVersions.files.metadata` |
| 哈希验证   | 使用API提供的哈希值校验     | 依赖`files.hashes`中的哈希值       |
| 文件组织   | 基于API返回的元数据进行分类 | 依赖模型类型、创建者等元数据       |

## API限制处理

| API限制/特性   | 处理策略                  | 实现方法                     |
| -------------- | ------------------------- | ---------------------------- |
| 需要认证的下载 | API密钥管理               | 安全存储和使用API Key        |
| 文件名获取     | 解析content-disposition头 | 处理HTTP响应头获取正确文件名 |
| 大文件下载     | 断点续传实现              | HTTP Range请求和分块处理     |
| 下载速度限制   | 并行下载控制              | 限制并发下载任务数量         |
| 服务器下载限制 | 请求延迟和重试策略        | 指数退避算法和错误处理       |
