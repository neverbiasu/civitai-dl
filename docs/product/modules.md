# 模块设计文档

## 模块架构

Civitai Downloader 采用基于API能力的三层架构，确保所有功能严格基于可用端点。

┌─────────────────────────────┐
│       用户界面层            │
│  ┌──────────┐ ┌──────────┐  │
│  │   CLI    │ │  WebUI   │  │
│  └──────────┘ └──────────┘  │
└─────────────────────────────┘
           ↑        ↑
           │        │
┌─────────────────────────────┐
│       业务逻辑层            │
│  ┌──────────┐ ┌──────────┐  │
│  │模型搜索与│ │ 模型下载 │  │
│  │  浏览    │ │          │  │
│  └──────────┘ └──────────┘  │
│  ┌──────────┐ ┌──────────┐  │
│  │图像下载  │ │ 元数据   │  │
│  │          │ │ 管理     │  │
│  └──────────┘ └──────────┘  │
└─────────────────────────────┘
           ↑        ↑
           │        │
┌─────────────────────────────┐
│       基础服务层            │
│  ┌──────────┐ ┌──────────┐  │
│  │ API客户端│ │下载引擎  │  │
│  └──────────┘ └──────────┘  │
│  ┌──────────┐ ┌──────────┐  │
│  │本地数据库│ │配置管理  │  │
│  └──────────┘ └──────────┘  │
└─────────────────────────────┘

## 核心模块职责

| 模块名称   | 主要职责                             | 关键技术                   |
| ---------- | ------------------------------------ | -------------------------- |
| API客户端  | 封装Civitai API调用，处理认证和请求  | Python Requests            |
| 下载引擎   | 管理下载任务队列，断点续传，并行控制 | ThreadPoolExecutor         |
| 模型搜索   | 处理搜索请求，解析和展示结果         | CLI：Click / WebUI：Gradio |
| 模型下载   | 处理文件下载，验证和组织模型文件     | Requests / hashlib         |
| 图像下载   | 下载和提取图像及其元数据             | PIL / ExifTool             |
| 元数据管理 | 存储和检索模型和图像的元数据         | SQLite / JSON              |

## 模块间关系

模块之间通过明确的依赖关系和接口进行交互，形成有机的整体系统：

- API客户端为模型搜索和下载模块提供数据
- 下载引擎为模型下载和图像下载提供服务
- 元数据管理为所有业务模块提供持久化支持
- 用户界面层通过统一接口调用业务逻辑层

## 用户界面模块

### CLI界面

命令行界面基于Click框架构建，提供脚本化和自动化能力，适合高级用户和批处理场景。

| 命令组   | 主要功能       | 典型用例                   |
| -------- | -------------- | -------------------------- |
| browse   | 浏览和搜索模型 | 查找特定类型或创作者的模型 |
| download | 下载模型和图像 | 批量下载选定的模型资源     |
| config   | 管理配置选项   | 设置下载路径和并发数量     |
| queue    | 管理下载队列   | 暂停、恢复和取消下载任务   |

### WebUI界面

图形用户界面基于Gradio构建，提供直观易用的交互体验，适合可视化操作和监控。

| 页面       | 主要功能       | 典型用例               |
| ---------- | -------------- | ---------------------- |
| 浏览页     | 搜索和筛选模型 | 视觉化浏览模型资源     |
| 下载管理页 | 管理下载任务   | 监控下载进度和控制任务 |
| 图像浏览页 | 查看已下载图像 | 浏览模型示例图像       |

## 业务逻辑模块

### 模型搜索

模型搜索模块处理用户查询，转换为API请求，并格式化结果供显示。

| 组件       | 职责                    | 输入/输出                      |
| ---------- | ----------------------- | ------------------------------ |
| 查询处理器 | 转换用户查询为API参数   | 输入：用户查询；输出：API参数  |
| 结果解析器 | 解析API响应为结构化数据 | 输入：API响应；输出：模型列表  |
| 筛选引擎   | 应用本地和远程筛选      | 输入：筛选条件；输出：筛选结果 |

### 模型下载

模型下载模块管理下载任务，确保可靠地获取模型文件并正确存储。

| 组件       | 职责                     | 输入/输出                      |
| ---------- | ------------------------ | ------------------------------ |
| 任务调度器 | 管理下载队列和任务优先级 | 输入：下载请求；输出：任务状态 |
| 文件管理器 | 处理文件存储和组织       | 输入：文件数据；输出：本地路径 |
| 验证器     | 验证下载文件的完整性     | 输入：文件；输出：验证结果     |

### 图像下载

图像下载模块专注于获取和管理模型示例图像。

| 组件         | 职责               | 输入/输出                          |
| ------------ | ------------------ | ---------------------------------- |
| 图像获取器   | 下载模型相关图像   | 输入：模型ID；输出：图像文件       |
| 元数据提取器 | 解析图像生成参数   | 输入：图像元数据；输出：参数       |
| 分类器       | 按规则组织图像文件 | 输入：图像和元数据；输出：文件路径 |

## 基础服务模块

### API客户端

API客户端封装Civitai API调用，处理认证、请求限制和错误恢复。

| 功能     | 描述                     | 处理方式                 |
| -------- | ------------------------ | ------------------------ |
| 请求封装 | 处理HTTP请求和响应格式化 | 统一请求格式，处理错误码 |
| 速率限制 | 避免触发API限流          | 请求队列和间隔控制       |
| 认证管理 | 安全处理API密钥          | 环境变量或配置文件存储   |

### 下载引擎

下载引擎提供高效、可靠的文件下载机制，支持大文件和不稳定网络环境。

| 功能     | 描述                 | 处理方式                   |
| -------- | -------------------- | -------------------------- |
| 并行下载 | 控制多任务并行执行   | 线程池管理与资源控制       |
| 断点续传 | 支持从中断处继续下载 | HTTP Range请求和分块处理   |
| 错误恢复 | 在网络错误时自动重试 | 指数退避算法和最大重试次数 |

### 数据存储

数据存储模块提供本地数据管理功能，包括配置、元数据和任务状态。

| 存储类型 | 用途                 | 实现方式               |
| -------- | -------------------- | ---------------------- |
| 配置存储 | 保存用户配置和偏好   | YAML或JSON文件         |
| 元数据库 | 存储模型和图像元数据 | SQLite数据库或JSON文件 |
| 状态缓存 | 保存任务状态和进度   | 内存缓存和持久化存储   |

## 数据流

系统中的数据主要沿以下路径流动：

1. 用户通过界面提交请求
2. 业务模块处理请求，调用API客户端获取数据
3. 下载引擎执行文件传输
4. 元数据和文件存储在本地系统
5. 状态和结果反馈给用户界面

## 扩展能力

系统设计为可扩展的架构，支持以下扩展点：

- **自定义筛选器**：添加新的模型筛选逻辑
- **下载后处理**：文件下载后的自动操作
- **元数据处理**：自定义元数据解析和存储
- **UI组件**：扩展WebUI界面
