# 图像下载

## 功能概述

图像下载模块基于Civitai的图像API，负责获取和管理模型示例图像。所有功能严格遵循API提供的能力范围，特别注意图像API的游标分页特性。

### 核心价值

- 视觉参考：获取API提供的模型示例图像
- 参数学习：提取API返回的图像生成参数
- 资源收集：基于多种API筛选条件获取图像
- 批量处理：有效处理API的分页机制

## API依赖分析

### 图像API关键特性

- 端点: `/api/v1/images`
- 分页方式: 游标分页（2023年7月2日后API更新，之前支持传统页码分页，现在必须使用游标分页）
- 关键参数: `modelId`, `modelVersionId`, `username`, `nsfw`
- 响应结构: 包含图像url、元数据和游标信息

### 图像数据结构

图像API返回的关键字段包括:
- `url`: 图像访问地址
- `nsfw`: 内容分级标记
- `width`/`height`: 图像尺寸
- `hash`: blurhash值，用于预览
- `meta`: 生成参数数据（如有）

## 基本功能

### 图像获取（基于`/api/v1/images`）

| 功能         | API参数实现             | API限制和注意事项           |
| ------------ | ----------------------- | --------------------------- |
| 单图下载     | 直接访问图像URL         | URL可能存在访问限制或有效期 |
| 模型示例下载 | `modelId=模型ID`        | 单次请求最多返回100张图像   |
| 版本示例下载 | `modelVersionId=版本ID` | 仅返回特定版本关联的图像    |

### 基础筛选（基于API参数）

| 功能         | API参数实现                 | API限制和注意事项          |
| ------------ | --------------------------- | -------------------------- |
| NSFW筛选     | `nsfw="None,Soft,Mature,X"` | 可组合多个级别，逗号分隔   |
| 创作者筛选   | `username="创作者名"`       | 单次请求仅支持一个创作者名 |
| 排序方式选择 | `sort="Most Reactions"`等   | 仅支持API定义的排序选项    |

## 高级功能

### 批量获取（处理API分页）

| 功能         | 实现方式                     | API依赖程度                     |
| ------------ | ---------------------------- | ------------------------------- |
| 游标分页处理 | 跟踪`nextCursor`或`nextPage` | 完全依赖API分页机制             |
| 智能批量下载 | 多次调用API处理所有页面      | 需控制请求频率避免限制          |
| 并行下载控制 | 本地并发控制                 | 纯本地功能，控制对图像URL的请求 |

### 元数据处理（基于API返回数据）

| 功能             | 数据来源                | API依赖程度               |
| ---------------- | ----------------------- | ------------------------- |
| 参数提取分析     | 图像响应中的`meta`字段  | 依赖API返回的元数据完整性 |
| 生成参数存储     | 基于返回的`meta`字段    | 仅能提取API提供的参数字段 |
| 多格式元数据保存 | 本地处理API返回的元数据 | 纯本地功能，基于API数据   |

## 游标分页处理策略

由于图像API使用游标分页而非传统页码分页，我们需要特别处理:

1. 初始请求不指定游标参数
2. 从响应的`metadata.nextCursor`获取下一页游标
3. 后续请求使用此游标值
4. 直到没有`nextCursor`或`nextPage`值

## API限制处理

| API限制/特性       | 处理策略                 | 实现方法                       |
| ------------------ | ------------------------ | ------------------------------ |
| 游标分页机制       | 正确跟踪和使用nextCursor | 持续跟踪分页元数据处理所有页面 |
| 单次请求图像数限制 | 多次请求处理所有结果     | 实现完整的分页处理流程         |
| 图像URL有效性      | 及时下载和缓存           | 避免URL过期导致无法访问        |
| 请求频率限制       | 控制请求间隔             | 实现请求延迟和队列管理         |
