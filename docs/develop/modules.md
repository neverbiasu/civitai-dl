# 模块架构设计

## 架构概述

Civitai Downloader采用分层模块化架构，将系统功能划分为清晰的模块组，每个模块负责特定的功能领域，具有明确的接口和责任边界。

### 架构分层

系统采用三层架构，确保关注点分离和模块独立性：

| 架构层       | 主要职责               | 代表模块                       |
| ------------ | ---------------------- | ------------------------------ |
| 表示层(前端) | 用户交互和展示         | CLI模块、WebUI模块             |
| 业务逻辑层   | 核心业务功能实现       | 模型搜索、模型下载、图像下载等 |
| 基础设施层   | 基础服务和外部系统集成 | API客户端、下载引擎、工具类    |

### 模块依赖关系图

```
┌─────────────────────────────────────────────────┐
│                    表示层                       │
│   ┌────────────────┐      ┌────────────────┐    │
│   │      CLI       │      │     WebUI      │    │
│   └────────────────┘      └────────────────┘    │
└─────────────────────────────────────────────────┘
               │                    │
               ▼                    ▼
┌─────────────────────────────────────────────────┐
│                  业务逻辑层                     │
│   ┌────────────┐ ┌────────────┐ ┌────────────┐  │
│   │模型搜索模块│ │模型下载模块│ │图像下载模块│  │
│   └────────────┘ └────────────┘ └────────────┘  │
│   ┌────────────┐ ┌────────────┐                 │
│   │元数据处理  │ │路径管理模块│                 │
│   └────────────┘ └────────────┘                 │
└─────────────────────────────────────────────────┘
               │                    │
               ▼                    ▼
┌─────────────────────────────────────────────────┐
│                 基础设施层                      │
│   ┌────────────┐ ┌────────────┐ ┌────────────┐  │
│   │ API客户端  │ │  下载引擎  │ │ 工具类     │  │
│   └────────────┘ └────────────┘ └────────────┘  │
│   ┌────────────┐                                │
│   │ 配置管理   │                                │
│   └────────────┘                                │
└─────────────────────────────────────────────────┘
```

## 核心模块清单

| 模块分类 | 模块名称   | 主要职责                         | 关键依赖                        |
| -------- | ---------- | -------------------------------- | ------------------------------- |
| 基础设施 | API客户端  | 封装Civitai API调用逻辑          | Python Requests                 |
| 基础设施 | 下载引擎   | 提供文件下载、断点续传等基础能力 | ThreadPoolExecutor              |
| 基础设施 | 配置管理   | 处理应用程序配置和用户偏好       | YAML/JSON                       |
| 基础设施 | 工具类     | 提供文件操作、路径处理等通用功能 | 标准库                          |
| 业务逻辑 | 模型搜索   | 实现模型查找、筛选和结果处理     | API客户端                       |
| 业务逻辑 | 模型下载   | 处理模型下载流程和任务管理       | API客户端、下载引擎             |
| 业务逻辑 | 图像下载   | 处理图像下载和元数据提取         | API客户端、下载引擎             |
| 业务逻辑 | 元数据处理 | 处理和组织模型与图像元数据       | API客户端                       |
| 业务逻辑 | 路径管理   | 管理文件存储路径和组织结构       | 配置管理                        |
| 表示层   | CLI模块    | 提供命令行交互界面               | Click, 所有业务逻辑模块         |
| 表示层   | WebUI模块  | 提供Web图形界面                  | Gradio/Vue.js, 所有业务逻辑模块 |

## 模块间通讯

模块间采用以下通信机制：

1. **直接调用**：同一层内模块通过明确的接口相互调用
2. **依赖注入**：高层模块通过构造函数注入依赖的低层模块实例
3. **事件通知**：异步场景（如下载进度更新）使用事件回调机制
4. **共享状态**：需要共享的全局状态（如下载队列）通过专用状态管理器管理

## 代码组织结构

项目采用基于功能的代码组织结构：

```
civitai-downloader/
├── civitai/                  # 主包
│   ├── __init__.py           # 包初始化
│   ├── api/                  # API客户端模块
│   │   ├── __init__.py
│   │   ├── client.py         # 主客户端
│   │   └── models.py         # API数据模型
│   ├── core/                 # 核心功能模块
│   │   ├── __init__.py
│   │   ├── downloader.py     # 下载引擎
│   │   └── config.py         # 配置管理
│   ├── models/               # 模型相关模块
│   │   ├── __init__.py
│   │   ├── browser.py        # 模型浏览搜索
│   │   └── downloader.py     # 模型下载管理
│   ├── images/               # 图像相关模块
│   │   ├── __init__.py
│   │   ├── browser.py        # 图像浏览
│   │   └── downloader.py     # 图像下载
│   ├── metadata/             # 元数据处理模块
│   │   ├── __init__.py
│   │   ├── extractor.py      # 元数据提取
│   │   └── manager.py        # 元数据管理
│   ├── cli/                  # 命令行界面
│   │   ├── __init__.py
│   │   ├── commands/         # 命令实现
│   │   └── main.py           # CLI入口
│   └── webui/                # Web界面
│       ├── __init__.py
│       ├── app.py            # 主应用
│       └── components/       # UI组件
├── tests/                    # 测试代码
└── docs/                     # 文档
```

## 模块扩展点

架构设计中提供了以下关键扩展点：

| 扩展点           | 位置                 | 扩展方式                     | 用途                   |
| ---------------- | -------------------- | ---------------------------- | ---------------------- |
| 自定义下载后处理 | `core.downloader`    | 注册回调函数或实现处理器接口 | 下载完成后自动处理文件 |
| 自定义元数据解析 | `metadata.extractor` | 实现自定义解析器并注册       | 支持新的元数据格式     |
| 自定义路径模板   | `models.downloader`  | 扩展路径模板引擎             | 个性化文件组织结构     |
| CLI命令扩展      | `cli.commands`       | 添加新命令类                 | 增加新的CLI功能        |
| WebUI界面扩展    | `webui.components`   | 添加新组件或页面             | 扩展WebUI功能          |

## 配置依赖

核心模块配置项及其默认值：

| 模块      | 配置项                  | 默认值                    | 说明               |
| --------- | ----------------------- | ------------------------- | ------------------ |
| API客户端 | `api.key`               | 空                        | Civitai API密钥    |
| API客户端 | `api.request_interval`  | `0.5`                     | 请求间隔(秒)       |
| 下载引擎  | `downloader.workers`    | `3`                       | 并行下载线程数     |
| 下载引擎  | `downloader.chunk_size` | `8192`                    | 下载分块大小(字节) |
| 下载引擎  | `downloader.retry`      | `3`                       | 下载失败重试次数   |
| 模型下载  | `models.path_template`  | `{type}/{creator}/{name}` | 模型保存路径模板   |
| 图像下载  | `images.path_template`  | `images/{model_id}/{id}`  | 图像保存路径模板   |

## 错误处理策略

各模块的错误处理和恢复策略：

| 模块          | 错误类型         | 处理策略                 | 恢复机制                        |
| ------------- | ---------------- | ------------------------ | ------------------------------- |
| API客户端     | 网络连接失败     | 指数退避重试             | 最多重试3次，成功后恢复正常间隔 |
| API客户端     | API速率限制(429) | 增加请求间隔，延时后重试 | 成功后逐步恢复正常间隔          |
| 下载引擎      | 下载中断         | 使用断点续传自动恢复     | 记录已下载部分，从断点处继续    |
| 下载引擎      | 校验失败         | 重新下载整个文件         | 删除损坏文件，重新加入下载队列  |
| 模型/图像下载 | 资源不可用       | 记录错误，跳过该资源     | 继续处理队列中其他任务          |
| 配置管理      | 配置文件损坏     | 使用默认值，记录错误日志 | 尝试创建新的默认配置文件        |

## 初始化和启动流程

系统启动流程遵循以下顺序：

1. 加载配置文件
2. 创建API客户端实例
3. 初始化下载引擎
4. 创建业务逻辑层模块
5. 初始化界面（CLI或WebUI）
6. 开始接受用户输入

这种启动顺序确保了依赖关系的正确初始化，使用依赖注入模式将低层模块实例传递给高层模块。

## 版本兼容性

模块版本兼容性策略：

| 模块类型     | 兼容性策略                 | 版本管理约定                |
| ------------ | -------------------------- | --------------------------- |
| 基础设施模块 | 严格版本控制，向后兼容     | 遵循语义化版本，明确API变更 |
| 业务逻辑模块 | 内部实现可变，接口稳定     | 主版本内保持接口兼容        |
| 表示层模块   | 可频繁迭代UI，保持命令兼容 | 弃用旧命令前提供过渡期      |

每个模块接口的变更都应在CHANGELOG中明确记录，并在必要时提供迁移指南。
