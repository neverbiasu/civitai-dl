# 系统架构设计

## 整体架构

Civitai Downloader采用分层模块化架构，可分为三层：接口层、业务层和基础设施层。系统各组件通过明确定义的接口进行交互，确保松散耦合和高内聚。

```
┌─────────────────────┐
│     接口层          │
│  ┌───────┐ ┌───────┐│
│  │  CLI  │ │ WebUI ││
│  └───────┘ └───────┘│
└─────────┬───────────┘
          ↓
┌─────────────────────┐
│     业务层          │
│┌─────────┐ ┌───────┐│
││模型浏览 │ │模型下载││
│└─────────┘ └───────┘│
│┌─────────┐ ┌───────┐│
││图像下载 │ │元数据  ││
│└─────────┘ └───────┘│
└─────────┬───────────┘
          ↓
┌─────────────────────┐
│   基础设施层        │
│┌─────────┐ ┌───────┐│
││API客户端│ │下载引擎││
│└─────────┘ └───────┘│
│┌─────────┐          │
││工具类   │          │
│└─────────┘          │
└─────────────────────┘
```

## 核心组件

### 1. 接口层

#### CLI模块

命令行界面模块基于Click框架，提供终端交互能力，适用于脚本化和高级用户。

**主要组件**:
- 命令解析器：处理命令行参数和选项
- 输出格式化器：格式化和展示命令结果
- 交互会话管理：处理用户交互式命令

**设计要点**:
- 每个主要功能对应一个命令组
- 参数和选项设计遵循CLI最佳实践
- 支持批处理和自动化使用场景

#### WebUI模块

Web用户界面模块基于Gradio框架，提供图形化交互体验，适用于视觉化操作和监控。

**主要组件**:
- 页面路由：管理不同功能页面
- UI组件：表单、表格、进度条等
- 事件处理器：处理用户交互事件

**设计要点**:
- 直观易用的界面设计
- 响应式布局适应不同设备
- 实时更新状态和进度

### 2. 业务层

#### 模型浏览模块

处理模型搜索和浏览相关业务逻辑，为用户提供模型发现能力。

**主要组件**:
- 搜索处理器：转换搜索条件为API请求
- 结果处理器：标准化和增强搜索结果
- 缓存管理：管理搜索结果缓存

**设计要点**:
- 支持复杂的组合搜索条件
- 高效处理大量搜索结果
- 搜索历史记录与建议

#### 模型下载模块

处理模型下载相关业务逻辑，管理下载任务和文件组织。

**主要组件**:
- 版本选择器：智能选择最佳模型版本
- 文件组织器：按规则组织下载文件
- 任务管理器：管理批量下载任务

**设计要点**:
- 智能处理模型版本和格式
- 可定制的文件组织策略
- 高效的批量下载队列管理

#### 图像下载模块

处理图像下载相关业务逻辑，包括检索和保存模型示例图像。

**主要组件**:
- 游标管理器：处理API分页特性
- 元数据提取器：提取和保存生成参数
- 图像组织器：分类和组织下载图像

**设计要点**:
- 正确处理游标分页特性
- 支持不同的筛选条件
- 高效处理大量图像数据

#### 元数据管理模块

管理模型和图像相关元数据，提供元数据提取和处理能力。

**主要组件**:
- 数据解析器：解析和标准化元数据
- 格式转换器：转换元数据格式
- 关联处理器：处理资源之间的关联

**设计要点**:
- 灵活的数据模型适应不同资源类型
- 支持多种元数据格式
- 提供清晰的元数据访问接口

### 3. 基础设施层

#### API客户端模块

封装与Civitai API的通信，处理请求和响应。

**主要组件**:
- 请求构建器：构建API请求
- 响应解析器：解析API响应
- 速率限制管理器：控制请求频率

**设计要点**:
- 健壮的错误处理和重试机制
- 请求频率自适应控制
- 认证和安全处理

#### 下载引擎模块

提供高效、可靠的文件下载能力，支持大型文件和并行下载。

**主要组件**:
- 任务调度器：管理下载任务队列
- 传输管理器：处理文件传输
- 状态跟踪器：监控下载进度

**设计要点**:
- 支持断点续传和错误恢复
- 有效的并行下载控制
- 性能优化针对大文件下载

#### 工具类模块

提供通用功能支持，如文件操作、哈希计算、路径管理等。

**主要组件**:
- 文件工具：处理文件系统操作
- 哈希工具：计算和验证哈希值
- 路径工具：处理路径和模板解析

**设计要点**:
- 高复用性与通用性
- 跨平台兼容性
- 性能优化关键操作

## 数据流

### 主要流程

1. **模型搜索流程**:
   ```
   CLI/WebUI → 模型浏览模块 → API客户端 → Civitai API → 
   返回结果 → 模型浏览模块(处理) → CLI/WebUI(展示)
   ```

2. **模型下载流程**:
   ```
   CLI/WebUI → 模型下载模块 → API客户端(获取模型信息) → 
   下载引擎(下载文件) → 文件系统(保存) → 
   元数据处理(处理信息) → CLI/WebUI(更新状态)
   ```

3. **图像下载流程**:
   ```
   CLI/WebUI → 图像下载模块 → API客户端(获取图像列表) → 
   下载引擎(下载图像) → 文件系统(保存) → 
   元数据处理(保存参数) → CLI/WebUI(更新状态)
   ```

### 数据存储

1. **文件存储**:
   - 模型文件：按配置的路径模板组织存储
   - 图像文件：按模型ID和其他维度组织
   - 元数据文件：与主文件关联存储

2. **内存数据**:
   - 当前下载任务状态和进度
   - 搜索结果缓存
   - 临时会话数据

## 扩展点

系统设计考虑以下扩展点，使未来功能增强更容易实现：

1. **新数据源适配**:
   - API客户端使用抽象接口，便于添加其他源
   - 数据模型标准化，允许融合不同来源数据

2. **自定义下载处理**:
   - 下载引擎支持下载后处理钩子
   - 可扩展的文件组织策略

3. **界面定制**:
   - WebUI支持主题和布局自定义
   - CLI可通过配置定制输出格式

4. **新功能模块**:
   - 清晰的模块边界和接口定义
   - 基于事件的松散耦合通信

## 性能考虑

1. **并行下载**:
   - 使用线程池实现并行下载
   - 可配置并行度以适应不同环境

2. **缓存策略**:
   - API响应缓存减少重复请求
   - 搜索结果缓存提高响应速度

3. **大文件处理**:
   - 流式处理避免内存问题
   - 分块处理大型文件

4. **资源控制**:
   - 动态调整资源使用
   - 避免过度占用系统资源

## 安全考虑

1. **API密钥处理**:
   - 安全存储用户凭据
   - 避免在日志中暴露敏感信息

2. **文件完整性**:
   - 下载文件哈希验证
   - 检测可能的损坏或篡改

3. **敏感内容管理**:
   - 按用户偏好过滤NSFW内容
   - 适当的内容警告机制
